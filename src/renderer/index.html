<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Code Viewer</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="header-left">
                <h1>🏔️ Claude Code Viewer</h1>
                <div class="status-info">
                    <span id="status-text">Ready</span>
                </div>
            </div>
            <div class="header-right">
                <button id="refresh-btn" class="header-btn">
                    <span>🔄</span> 更新
                </button>
                <button id="settings-btn" class="header-btn">
                    <span>⚙️</span> 設定
                </button>
            </div>
        </header>
        
        <main class="main-content">
            <div class="content-panes">
                <aside class="project-pane">
                    <div class="pane-header">
                        <h3>📁 プロジェクト一覧</h3>
                    </div>
                    <div class="project-list" id="project-list">
                        <!-- プロジェクト一覧がここに動的に追加される -->
                    </div>
                </aside>
                
                <section class="file-pane">
                    <div class="file-list-container">
                        <table class="file-list" id="file-list">
                            <thead>
                                <tr>
                                    <th id="sort-name" class="sortable" data-sort="name">
                                        ファイル名 <span class="sort-arrow"></span>
                                    </th>
                                    <th id="sort-date" class="sortable active" data-sort="date">
                                        更新日時 <span class="sort-arrow">▼</span>
                                    </th>
                                    <th id="sort-size" class="sortable" data-sort="size">
                                        サイズ <span class="sort-arrow"></span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="file-list-body">
                                <!-- ファイル一覧がここに動的に追加される -->
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>
        </main>
        
        <footer class="app-footer">
            <div class="footer-content">
                <div class="status-left">
                    <span id="status-message">Ready</span>
                </div>
                <div class="status-right">
                    <span id="selection-info">プロジェクト未選択</span>
                    <span id="theme-indicator">🌙</span>
                </div>
            </div>
        </footer>
    </div>
    
    <!-- コンテキストメニュー -->
    <div id="context-menu" class="context-menu">
        <div class="context-menu-item" id="context-show-in-finder">
            <span class="icon">📁</span>
            <span>Finderで表示</span>
        </div>
    </div>
    
    <script>
        // 実データ管理
        let projects = [];
        let selectedProject = null;
        let selectedFile = null;
        let currentSort = { column: 'date', ascending: false }; // デフォルト：日時降順
        let currentFiles = [];
        
        // コンテキストメニュー管理
        let contextMenuTarget = null;

        function updateStatus(message) {
            const statusElement = document.getElementById('status-message');
            if (statusElement) {
                statusElement.textContent = message;
            }
        }

        function updateSelectionInfo() {
            const selectionElement = document.getElementById('selection-info');
            if (!selectionElement) return;
            
            let info = '';
            if (selectedProject) {
                const fileCount = currentFiles.length;
                info = `${selectedProject.name} - ${fileCount} files`;
                if (selectedFile) {
                    info += ` - ${selectedFile.name}`;
                }
            } else {
                info = 'プロジェクト未選択';
            }
            selectionElement.textContent = info;
        }

        async function loadProjects() {
            const projectList = document.getElementById('project-list');
            
            if (!projectList) {
                return;
            }

            try {
                updateStatus('プロジェクト検索中...');
                
                // Electron APIでプロジェクト一覧を取得
                projects = await window.electronAPI.getProjects();
                
                // プロジェクト一覧をクリア
                projectList.innerHTML = '';
                
                if (projects.length === 0) {
                    // プロジェクトが見つからない場合
                    await window.electronAPI.showErrorDialog(
                        'Claude Projectsが見つかりません',
                        'Claude Codeを使用していますか？\n~/.claude/projects フォルダが見つかりません。'
                    );
                    updateStatus('プロジェクトが見つかりません');
                    return;
                }
                
                // プロジェクトリストを表示
                projects.forEach(project => {
                    const projectElement = document.createElement('div');
                    projectElement.className = 'project-item';
                    projectElement.innerHTML = `
                        <span class="project-icon">📁</span>
                        <span class="project-name">${project.name}</span>
                    `;
                    
                    projectElement.addEventListener('click', () => {
                        selectProject(project);
                    });
                    
                    projectElement.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        showContextMenu(e.clientX, e.clientY, project.path, false);
                    });
                    
                    projectList.appendChild(projectElement);
                });
                
                updateStatus(`${projects.length}個のプロジェクトが見つかりました`);
                setTimeout(() => updateStatus('Ready'), 1500);
                
            } catch (error) {
                console.error('Error loading projects:', error);
                updateStatus('プロジェクト読み込みエラー');
                await window.electronAPI.showErrorDialog(
                    'エラー',
                    'プロジェクトの読み込みに失敗しました。'
                );
            }
        }

        async function selectProject(project) {
            selectedProject = project;
            selectedFile = null; // ファイル選択をリセット
            
            // 選択状態更新
            document.querySelectorAll('.project-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            const projectElements = Array.from(document.querySelectorAll('.project-item'));
            const selectedElement = projectElements.find(element => 
                element.querySelector('.project-name')?.textContent === project.name
            );
            selectedElement?.classList.add('selected');
            
            await loadFiles();
            updateSelectionInfo();
        }

        function sortFiles(files, column, ascending) {
            return [...files].sort((a, b) => {
                let valueA, valueB;
                
                switch(column) {
                    case 'name':
                        valueA = a.name.toLowerCase();
                        valueB = b.name.toLowerCase();
                        break;
                    case 'date':
                        // 実データではmtimeオブジェクトを使用
                        if (a.mtime && b.mtime) {
                            valueA = new Date(a.mtime);
                            valueB = new Date(b.mtime);
                        } else {
                            // フォールバック：文字列から日時解析
                            valueA = new Date(a.date.replace(' ', 'T'));
                            valueB = new Date(b.date.replace(' ', 'T'));
                        }
                        break;
                    case 'size':
                        // サイズを数値に変換（MB単位）
                        valueA = parseFloat(a.size.replace('MB', ''));
                        valueB = parseFloat(b.size.replace('MB', ''));
                        break;
                    default:
                        return 0;
                }
                
                if (valueA < valueB) return ascending ? -1 : 1;
                if (valueA > valueB) return ascending ? 1 : -1;
                return 0;
            });
        }

        function updateSortHeaders() {
            // 全てのヘッダーをリセット
            document.querySelectorAll('.sortable').forEach(th => {
                th.classList.remove('active');
                th.querySelector('.sort-arrow').textContent = '';
            });
            
            // アクティブなソートカラムを設定
            const activeHeader = document.querySelector(`[data-sort="${currentSort.column}"]`);
            if (activeHeader) {
                activeHeader.classList.add('active');
                const arrow = activeHeader.querySelector('.sort-arrow');
                if (arrow) {
                    arrow.textContent = currentSort.ascending ? '▲' : '▼';
                }
            }
        }

        async function loadFiles() {
            const fileListBody = document.getElementById('file-list-body');
            
            if (!fileListBody || !selectedProject) {
                return;
            }

            fileListBody.innerHTML = '';
            
            try {
                updateStatus(`${selectedProject.name} のファイルを読み込み中...`);
                
                // Electron APIでプロジェクトのファイル一覧を取得
                currentFiles = await window.electronAPI.getProjectFiles(selectedProject.path);
                
                if (currentFiles.length === 0) {
                    // ファイルがない場合
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="3" style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                            JSONLファイルが見つかりません
                        </td>
                    `;
                    fileListBody.appendChild(row);
                    updateStatus('ファイルが見つかりません');
                    return;
                }
                
                // ソート適用
                const sortedFiles = sortFiles(currentFiles, currentSort.column, currentSort.ascending);
            
            sortedFiles.forEach(file => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>📄 ${file.name}</td>
                    <td>${file.date}</td>
                    <td>${file.size}</td>
                `;
                
                row.addEventListener('click', () => {
                    selectFile(file);
                });
                
                row.addEventListener('dblclick', async () => {
                    await openFile(file);
                });
                
                row.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    showContextMenu(e.clientX, e.clientY, file.fullPath, true);
                });
                
                    fileListBody.appendChild(row);
                });

                // ソートヘッダーを更新
                updateSortHeaders();
                
                updateStatus(`${currentFiles.length}個のファイルを読み込みました`);
                setTimeout(() => updateStatus('Ready'), 1500);
                
            } catch (error) {
                console.error('Error loading files:', error);
                updateStatus('ファイル読み込みエラー');
            }
        }

        function selectFile(file) {
            selectedFile = file;
            
            document.querySelectorAll('.file-list tbody tr').forEach(row => {
                row.classList.remove('selected');
            });
            
            const fileRows = Array.from(document.querySelectorAll('.file-list tbody tr'));
            const selectedRow = fileRows.find(row => 
                row.textContent?.includes(file.name)
            );
            selectedRow?.classList.add('selected');
            
            updateSelectionInfo();
        }

        async function openFile(file) {
            try {
                updateStatus(`変換準備中: ${file.name}`);
                
                // 一時的な出力ディレクトリ
                const outputDir = '/tmp/claude-viewer-conversion';
                
                updateStatus(`変換中: ${file.name}`);
                
                // JSONL→MD変換を実行
                const result = await window.electronAPI.convertJsonlToMd(file.fullPath, outputDir);
                
                if (result.success && result.mdPath) {
                    updateStatus(`変換完了: ${file.name}`);
                    
                    // TODO: Phase 6-7で実装予定 - MD→HTML変換とモーダル表示
                    console.log('Generated MD file:', result.mdPath);
                    
                    setTimeout(() => updateStatus('Ready'), 2000);
                } else {
                    throw new Error(result.error || '変換に失敗しました');
                }
                
            } catch (error) {
                console.error('File conversion error:', error);
                updateStatus('変換エラー');
                await window.electronAPI.showErrorDialog(
                    '変換エラー',
                    `ファイルの変換に失敗しました:\n${error.message || error}`
                );
                setTimeout(() => updateStatus('Ready'), 1000);
            }
        }

        // DOM読み込み完了時の処理
        document.addEventListener('DOMContentLoaded', function() {
            
            // ボタンイベント
            const refreshBtn = document.getElementById('refresh-btn');
            const settingsBtn = document.getElementById('settings-btn');
            
            refreshBtn?.addEventListener('click', async () => {
                updateStatus('更新中...');
                try {
                    await loadProjects();
                    updateStatus('更新完了');
                    setTimeout(() => updateStatus('Ready'), 1000);
                } catch (error) {
                    console.error('Error refreshing projects:', error);
                    updateStatus('更新エラー');
                }
            });
            
            settingsBtn?.addEventListener('click', () => {
                updateStatus('設定画面（未実装）');
                setTimeout(() => updateStatus('Ready'), 1000);
            });

            // ソートイベント
            document.querySelectorAll('.sortable').forEach(th => {
                th.addEventListener('click', () => {
                    const column = th.getAttribute('data-sort');
                    
                    if (currentSort.column === column) {
                        // 同じカラムをクリックした場合は昇順/降順を切り替え
                        currentSort.ascending = !currentSort.ascending;
                    } else {
                        // 異なるカラムをクリックした場合は新しいカラムで降順
                        currentSort.column = column;
                        currentSort.ascending = false;
                    }
                    
                    // ファイル一覧を再読み込み（ソート適用）
                    if (selectedProject) {
                        loadFiles();
                    }
                });
            });

            // コンテキストメニューのイベント設定
            const contextShowInFinder = document.getElementById('context-show-in-finder');
            contextShowInFinder?.addEventListener('click', async () => {
                if (contextMenuTarget && contextMenuTarget.path) {
                    await window.electronAPI.showInFinder(contextMenuTarget.path);
                    updateStatus(`Finderで表示: ${contextMenuTarget.path.split('/').pop()}`);
                    setTimeout(() => updateStatus('Ready'), 1500);
                }
                hideContextMenu();
            });

            // コンテキストメニューを隠すイベント
            document.addEventListener('click', () => {
                hideContextMenu();
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    hideContextMenu();
                }
            });

            // テーマ初期化
            updateTheme();
            
            // プロジェクト読み込み
            loadProjects();
            updateStatus('Ready');
        });

        function showContextMenu(x, y, targetPath, isFile = true) {
            const contextMenu = document.getElementById('context-menu');
            if (!contextMenu) return;
            
            contextMenuTarget = { path: targetPath, isFile: isFile };
            
            // 画面端での調整
            const rect = document.body.getBoundingClientRect();
            const menuWidth = 150;
            const menuHeight = 50;
            
            const adjustedX = Math.min(x, rect.width - menuWidth);
            const adjustedY = Math.min(y, rect.height - menuHeight);
            
            contextMenu.style.left = adjustedX + 'px';
            contextMenu.style.top = adjustedY + 'px';
            contextMenu.style.display = 'block';
        }

        function hideContextMenu() {
            const contextMenu = document.getElementById('context-menu');
            if (contextMenu) {
                contextMenu.style.display = 'none';
            }
            contextMenuTarget = null;
        }

        function updateTheme() {
            const isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
            
            const themeIndicator = document.getElementById('theme-indicator');
            if (themeIndicator) {
                themeIndicator.textContent = isDark ? '🌙' : '☀️';
            }
        }

        // テーマ変更監視
        if (window.matchMedia) {
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', updateTheme);
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Code Viewer</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="header-left">
                <h1>ğŸ”ï¸ Claude Code Viewer</h1>
                <div class="status-info">
                    <span id="status-text">Ready</span>
                </div>
            </div>
            <div class="header-right">
                <button id="refresh-btn" class="header-btn">
                    <span>ğŸ”„</span> æ›´æ–°
                </button>
                <button id="settings-btn" class="header-btn">
                    <span>âš™ï¸</span> è¨­å®š
                </button>
            </div>
        </header>
        
        <main class="main-content">
            <div class="content-panes">
                <aside class="project-pane">
                    <div class="pane-header">
                        <h3>ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§</h3>
                    </div>
                    <div class="project-list" id="project-list">
                        <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                    </div>
                </aside>
                
                <section class="file-pane">
                    <div class="file-list-container">
                        <table class="file-list" id="file-list">
                            <thead>
                                <tr>
                                    <th id="sort-name" class="sortable" data-sort="name">
                                        ãƒ•ã‚¡ã‚¤ãƒ«å <span class="sort-arrow"></span>
                                    </th>
                                    <th id="sort-date" class="sortable active" data-sort="date">
                                        æ›´æ–°æ—¥æ™‚ <span class="sort-arrow">â–¼</span>
                                    </th>
                                    <th id="sort-size" class="sortable" data-sort="size">
                                        ã‚µã‚¤ã‚º <span class="sort-arrow"></span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="file-list-body">
                                <!-- ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>
        </main>
        
        <footer class="app-footer">
            <div class="footer-content">
                <div class="status-left">
                    <span id="status-message">Ready</span>
                </div>
                <div class="status-right">
                    <span id="selection-info">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæœªé¸æŠ</span>
                    <span id="theme-indicator">ğŸŒ™</span>
                </div>
            </div>
        </footer>
    </div>
    
    <!-- ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div id="context-menu" class="context-menu">
        <div class="context-menu-item" id="context-show-in-finder">
            <span class="icon">ğŸ“</span>
            <span>Finderã§è¡¨ç¤º</span>
        </div>
    </div>
    
    <script>
        // å®Ÿãƒ‡ãƒ¼ã‚¿ç®¡ç†
        let projects = [];
        let selectedProject = null;
        let selectedFile = null;
        let currentSort = { column: 'date', ascending: false }; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šæ—¥æ™‚é™é †
        let currentFiles = [];
        
        // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ç®¡ç†
        let contextMenuTarget = null;

        function updateStatus(message) {
            const statusElement = document.getElementById('status-message');
            if (statusElement) {
                statusElement.textContent = message;
            }
        }

        function updateSelectionInfo() {
            const selectionElement = document.getElementById('selection-info');
            if (!selectionElement) return;
            
            let info = '';
            if (selectedProject) {
                const fileCount = currentFiles.length;
                info = `${selectedProject.name} - ${fileCount} files`;
                if (selectedFile) {
                    info += ` - ${selectedFile.name}`;
                }
            } else {
                info = 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæœªé¸æŠ';
            }
            selectionElement.textContent = info;
        }

        async function loadProjects() {
            const projectList = document.getElementById('project-list');
            
            if (!projectList) {
                return;
            }

            try {
                updateStatus('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¤œç´¢ä¸­...');
                
                // Electron APIã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚’å–å¾—
                projects = await window.electronAPI.getProjects();
                
                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§ã‚’ã‚¯ãƒªã‚¢
                projectList.innerHTML = '';
                
                if (projects.length === 0) {
                    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
                    await window.electronAPI.showErrorDialog(
                        'Claude ProjectsãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
                        'Claude Codeã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ\n~/.claude/projects ãƒ•ã‚©ãƒ«ãƒ€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚'
                    );
                    updateStatus('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
                projects.forEach(project => {
                    const projectElement = document.createElement('div');
                    projectElement.className = 'project-item';
                    projectElement.innerHTML = `
                        <span class="project-icon">ğŸ“</span>
                        <span class="project-name">${project.name}</span>
                    `;
                    
                    projectElement.addEventListener('click', () => {
                        selectProject(project);
                    });
                    
                    projectElement.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        showContextMenu(e.clientX, e.clientY, project.path, false);
                    });
                    
                    projectList.appendChild(projectElement);
                });
                
                updateStatus(`${projects.length}å€‹ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`);
                setTimeout(() => updateStatus('Ready'), 1500);
                
            } catch (error) {
                console.error('Error loading projects:', error);
                updateStatus('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼');
                await window.electronAPI.showErrorDialog(
                    'ã‚¨ãƒ©ãƒ¼',
                    'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'
                );
            }
        }

        async function selectProject(project) {
            selectedProject = project;
            selectedFile = null; // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
            
            // é¸æŠçŠ¶æ…‹æ›´æ–°
            document.querySelectorAll('.project-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            const projectElements = Array.from(document.querySelectorAll('.project-item'));
            const selectedElement = projectElements.find(element => 
                element.querySelector('.project-name')?.textContent === project.name
            );
            selectedElement?.classList.add('selected');
            
            await loadFiles();
            updateSelectionInfo();
        }

        function sortFiles(files, column, ascending) {
            return [...files].sort((a, b) => {
                let valueA, valueB;
                
                switch(column) {
                    case 'name':
                        valueA = a.name.toLowerCase();
                        valueB = b.name.toLowerCase();
                        break;
                    case 'date':
                        // å®Ÿãƒ‡ãƒ¼ã‚¿ã§ã¯mtimeã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½¿ç”¨
                        if (a.mtime && b.mtime) {
                            valueA = new Date(a.mtime);
                            valueB = new Date(b.mtime);
                        } else {
                            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šæ–‡å­—åˆ—ã‹ã‚‰æ—¥æ™‚è§£æ
                            valueA = new Date(a.date.replace(' ', 'T'));
                            valueB = new Date(b.date.replace(' ', 'T'));
                        }
                        break;
                    case 'size':
                        // ã‚µã‚¤ã‚ºã‚’æ•°å€¤ã«å¤‰æ›ï¼ˆMBå˜ä½ï¼‰
                        valueA = parseFloat(a.size.replace('MB', ''));
                        valueB = parseFloat(b.size.replace('MB', ''));
                        break;
                    default:
                        return 0;
                }
                
                if (valueA < valueB) return ascending ? -1 : 1;
                if (valueA > valueB) return ascending ? 1 : -1;
                return 0;
            });
        }

        function updateSortHeaders() {
            // å…¨ã¦ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.querySelectorAll('.sortable').forEach(th => {
                th.classList.remove('active');
                th.querySelector('.sort-arrow').textContent = '';
            });
            
            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚½ãƒ¼ãƒˆã‚«ãƒ©ãƒ ã‚’è¨­å®š
            const activeHeader = document.querySelector(`[data-sort="${currentSort.column}"]`);
            if (activeHeader) {
                activeHeader.classList.add('active');
                const arrow = activeHeader.querySelector('.sort-arrow');
                if (arrow) {
                    arrow.textContent = currentSort.ascending ? 'â–²' : 'â–¼';
                }
            }
        }

        async function loadFiles() {
            const fileListBody = document.getElementById('file-list-body');
            
            if (!fileListBody || !selectedProject) {
                return;
            }

            fileListBody.innerHTML = '';
            
            try {
                updateStatus(`${selectedProject.name} ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...`);
                
                // Electron APIã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’å–å¾—
                currentFiles = await window.electronAPI.getProjectFiles(selectedProject.path);
                
                if (currentFiles.length === 0) {
                    // ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„å ´åˆ
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="3" style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                            JSONLãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“
                        </td>
                    `;
                    fileListBody.appendChild(row);
                    updateStatus('ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                // ã‚½ãƒ¼ãƒˆé©ç”¨
                const sortedFiles = sortFiles(currentFiles, currentSort.column, currentSort.ascending);
            
            sortedFiles.forEach(file => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>ğŸ“„ ${file.name}</td>
                    <td>${file.date}</td>
                    <td>${file.size}</td>
                `;
                
                row.addEventListener('click', () => {
                    selectFile(file);
                });
                
                row.addEventListener('dblclick', async () => {
                    await openFile(file);
                });
                
                row.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    showContextMenu(e.clientX, e.clientY, file.fullPath, true);
                });
                
                    fileListBody.appendChild(row);
                });

                // ã‚½ãƒ¼ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ›´æ–°
                updateSortHeaders();
                
                updateStatus(`${currentFiles.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
                setTimeout(() => updateStatus('Ready'), 1500);
                
            } catch (error) {
                console.error('Error loading files:', error);
                updateStatus('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼');
            }
        }

        function selectFile(file) {
            selectedFile = file;
            
            document.querySelectorAll('.file-list tbody tr').forEach(row => {
                row.classList.remove('selected');
            });
            
            const fileRows = Array.from(document.querySelectorAll('.file-list tbody tr'));
            const selectedRow = fileRows.find(row => 
                row.textContent?.includes(file.name)
            );
            selectedRow?.classList.add('selected');
            
            updateSelectionInfo();
        }

        async function openFile(file) {
            try {
                updateStatus(`å¤‰æ›æº–å‚™ä¸­: ${file.name}`);
                
                // ä¸€æ™‚çš„ãªå‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
                const outputDir = '/tmp/claude-viewer-conversion';
                
                updateStatus(`å¤‰æ›ä¸­: ${file.name}`);
                
                // JSONLâ†’MDå¤‰æ›ã‚’å®Ÿè¡Œ
                const result = await window.electronAPI.convertJsonlToMd(file.fullPath, outputDir);
                
                if (result.success && result.mdPath) {
                    updateStatus(`å¤‰æ›å®Œäº†: ${file.name}`);
                    
                    // TODO: Phase 6-7ã§å®Ÿè£…äºˆå®š - MDâ†’HTMLå¤‰æ›ã¨ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
                    console.log('Generated MD file:', result.mdPath);
                    
                    setTimeout(() => updateStatus('Ready'), 2000);
                } else {
                    throw new Error(result.error || 'å¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
            } catch (error) {
                console.error('File conversion error:', error);
                updateStatus('å¤‰æ›ã‚¨ãƒ©ãƒ¼');
                await window.electronAPI.showErrorDialog(
                    'å¤‰æ›ã‚¨ãƒ©ãƒ¼',
                    `ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸ:\n${error.message || error}`
                );
                setTimeout(() => updateStatus('Ready'), 1000);
            }
        }

        // DOMèª­ã¿è¾¼ã¿å®Œäº†æ™‚ã®å‡¦ç†
        document.addEventListener('DOMContentLoaded', function() {
            
            // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
            const refreshBtn = document.getElementById('refresh-btn');
            const settingsBtn = document.getElementById('settings-btn');
            
            refreshBtn?.addEventListener('click', async () => {
                updateStatus('æ›´æ–°ä¸­...');
                try {
                    await loadProjects();
                    updateStatus('æ›´æ–°å®Œäº†');
                    setTimeout(() => updateStatus('Ready'), 1000);
                } catch (error) {
                    console.error('Error refreshing projects:', error);
                    updateStatus('æ›´æ–°ã‚¨ãƒ©ãƒ¼');
                }
            });
            
            settingsBtn?.addEventListener('click', () => {
                updateStatus('è¨­å®šç”»é¢ï¼ˆæœªå®Ÿè£…ï¼‰');
                setTimeout(() => updateStatus('Ready'), 1000);
            });

            // ã‚½ãƒ¼ãƒˆã‚¤ãƒ™ãƒ³ãƒˆ
            document.querySelectorAll('.sortable').forEach(th => {
                th.addEventListener('click', () => {
                    const column = th.getAttribute('data-sort');
                    
                    if (currentSort.column === column) {
                        // åŒã˜ã‚«ãƒ©ãƒ ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã¯æ˜‡é †/é™é †ã‚’åˆ‡ã‚Šæ›¿ãˆ
                        currentSort.ascending = !currentSort.ascending;
                    } else {
                        // ç•°ãªã‚‹ã‚«ãƒ©ãƒ ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã¯æ–°ã—ã„ã‚«ãƒ©ãƒ ã§é™é †
                        currentSort.column = column;
                        currentSort.ascending = false;
                    }
                    
                    // ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿ï¼ˆã‚½ãƒ¼ãƒˆé©ç”¨ï¼‰
                    if (selectedProject) {
                        loadFiles();
                    }
                });
            });

            // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
            const contextShowInFinder = document.getElementById('context-show-in-finder');
            contextShowInFinder?.addEventListener('click', async () => {
                if (contextMenuTarget && contextMenuTarget.path) {
                    await window.electronAPI.showInFinder(contextMenuTarget.path);
                    updateStatus(`Finderã§è¡¨ç¤º: ${contextMenuTarget.path.split('/').pop()}`);
                    setTimeout(() => updateStatus('Ready'), 1500);
                }
                hideContextMenu();
            });

            // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’éš ã™ã‚¤ãƒ™ãƒ³ãƒˆ
            document.addEventListener('click', () => {
                hideContextMenu();
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    hideContextMenu();
                }
            });

            // ãƒ†ãƒ¼ãƒåˆæœŸåŒ–
            updateTheme();
            
            // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª­ã¿è¾¼ã¿
            loadProjects();
            updateStatus('Ready');
        });

        function showContextMenu(x, y, targetPath, isFile = true) {
            const contextMenu = document.getElementById('context-menu');
            if (!contextMenu) return;
            
            contextMenuTarget = { path: targetPath, isFile: isFile };
            
            // ç”»é¢ç«¯ã§ã®èª¿æ•´
            const rect = document.body.getBoundingClientRect();
            const menuWidth = 150;
            const menuHeight = 50;
            
            const adjustedX = Math.min(x, rect.width - menuWidth);
            const adjustedY = Math.min(y, rect.height - menuHeight);
            
            contextMenu.style.left = adjustedX + 'px';
            contextMenu.style.top = adjustedY + 'px';
            contextMenu.style.display = 'block';
        }

        function hideContextMenu() {
            const contextMenu = document.getElementById('context-menu');
            if (contextMenu) {
                contextMenu.style.display = 'none';
            }
            contextMenuTarget = null;
        }

        function updateTheme() {
            const isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
            
            const themeIndicator = document.getElementById('theme-indicator');
            if (themeIndicator) {
                themeIndicator.textContent = isDark ? 'ğŸŒ™' : 'â˜€ï¸';
            }
        }

        // ãƒ†ãƒ¼ãƒå¤‰æ›´ç›£è¦–
        if (window.matchMedia) {
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', updateTheme);
        }
    </script>
</body>
</html>